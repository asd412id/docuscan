# Production docker-compose.yml
# Full production deployment with all services in containers
#
# Network Architecture (Security):
#   - frontend-network: Only frontend (exposed to outside)
#   - backend-network: Frontend <-> Backend communication
#   - data-network: Backend/Celery <-> Database/Redis (internal only)
#   - monitoring-network: Flower <-> Redis (internal only)
#
# Usage:
#   docker-compose up -d --build
#
# With monitoring dashboard (Celery Flower):
#   docker-compose --profile monitoring up -d --build
#
# All variables can be configured via .env file
# See .env.example for all available options

services:
  # ===========================================
  # Frontend - Nginx + React SPA
  # ONLY SERVICE EXPOSED TO OUTSIDE
  # ===========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-}
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      - BACKEND_HOST=backend
      - BACKEND_PORT=8000
      - CLIENT_MAX_BODY_SIZE=${MAX_UPLOAD_SIZE_MB:-20}m
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - frontend-network
      - backend-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: ${FRONTEND_MEMORY_LIMIT:-256M}
          cpus: "${FRONTEND_CPU_LIMIT:-0.5}"

  # ===========================================
  # Backend - FastAPI Application
  # NOT exposed to outside, only via frontend proxy
  # ===========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - TESSERACT_LANGUAGES=${TESSERACT_LANGUAGES:-eng ind}
        - UVICORN_WORKERS=${UVICORN_WORKERS:-2}
    # NO ports exposed - only accessible via frontend nginx proxy
    # Uncomment for debugging only:
    # ports:
    #   - "127.0.0.1:${BACKEND_PORT:-8000}:8000"
    environment:
      # Application
      - APP_NAME=${APP_NAME:-DocuScan}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - DEBUG=${DEBUG:-false}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost}
      # Security
      - SECRET_KEY=${SECRET_KEY:?SECRET_KEY is required}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      # Database
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-docuscan}:${POSTGRES_PASSWORD:-docuscan}@db:5432/${POSTGRES_DB:-docuscan}
      # Redis
      - REDIS_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/0
      - REDIS_ENABLED=${REDIS_ENABLED:-true}
      # Celery
      - CELERY_BROKER_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/1
      - CELERY_RESULT_BACKEND=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/2
      - CELERY_ENABLED=${CELERY_ENABLED:-true}
      # Rate Limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_DEFAULT=${RATE_LIMIT_DEFAULT:-100/minute}
      - RATE_LIMIT_AUTH=${RATE_LIMIT_AUTH:-10/minute}
      - RATE_LIMIT_UPLOAD=${RATE_LIMIT_UPLOAD:-20/minute}
      - RATE_LIMIT_PROCESS=${RATE_LIMIT_PROCESS:-30/minute}
      # File Storage
      - UPLOAD_DIR=/app/uploads
      - MAX_UPLOAD_SIZE_MB=${MAX_UPLOAD_SIZE_MB:-20}
      - FILE_RETENTION_MINUTES=${FILE_RETENTION_MINUTES:-60}
      # OCR
      - TESSERACT_CMD=/usr/bin/tesseract
    volumes:
      - upload-data:/app/uploads
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend-network
      - data-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: ${BACKEND_MEMORY_LIMIT:-1G}
          cpus: "${BACKEND_CPU_LIMIT:-2}"

  # ===========================================
  # Celery Worker - Background Task Processing
  # Internal only - connects to Redis & DB
  # ===========================================
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - TESSERACT_LANGUAGES=${TESSERACT_LANGUAGES:-eng ind}
    command: >
      celery -A app.celery_app worker
      --loglevel=${CELERY_LOG_LEVEL:-info}
      --concurrency=${CELERY_CONCURRENCY:-2}
    environment:
      # Application
      - APP_NAME=${APP_NAME:-DocuScan}
      - DEBUG=${DEBUG:-false}
      # Security
      - SECRET_KEY=${SECRET_KEY:?SECRET_KEY is required}
      - ALGORITHM=${ALGORITHM:-HS256}
      # Database
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-docuscan}:${POSTGRES_PASSWORD:-docuscan}@db:5432/${POSTGRES_DB:-docuscan}
      # Redis
      - REDIS_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/0
      - REDIS_ENABLED=${REDIS_ENABLED:-true}
      # Celery
      - CELERY_BROKER_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/1
      - CELERY_RESULT_BACKEND=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/2
      - CELERY_ENABLED=${CELERY_ENABLED:-true}
      # File Storage
      - UPLOAD_DIR=/app/uploads
      - MAX_UPLOAD_SIZE_MB=${MAX_UPLOAD_SIZE_MB:-20}
      - FILE_RETENTION_MINUTES=${FILE_RETENTION_MINUTES:-60}
      # OCR
      - TESSERACT_CMD=/usr/bin/tesseract
    volumes:
      - upload-data:/app/uploads
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - data-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${CELERY_MEMORY_LIMIT:-1G}
          cpus: "${CELERY_CPU_LIMIT:-2}"

  # ===========================================
  # Celery Beat - Scheduled Tasks (Optional)
  # Internal only - connects to Redis
  # ===========================================
  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - TESSERACT_LANGUAGES=${TESSERACT_LANGUAGES:-eng ind}
    command: celery -A app.celery_app beat --loglevel=${CELERY_LOG_LEVEL:-info}
    environment:
      - APP_NAME=${APP_NAME:-DocuScan}
      - DEBUG=${DEBUG:-false}
      - SECRET_KEY=${SECRET_KEY:?SECRET_KEY is required}
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-docuscan}:${POSTGRES_PASSWORD:-docuscan}@db:5432/${POSTGRES_DB:-docuscan}
      - REDIS_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/0
      - CELERY_BROKER_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/1
      - CELERY_RESULT_BACKEND=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/2
      - CELERY_ENABLED=${CELERY_ENABLED:-true}
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_started
    networks:
      - data-network
    restart: unless-stopped
    profiles:
      - scheduler
    deploy:
      resources:
        limits:
          memory: ${CELERY_BEAT_MEMORY_LIMIT:-256M}
          cpus: "${CELERY_BEAT_CPU_LIMIT:-0.25}"

  # ===========================================
  # Celery Flower - Task Monitoring Dashboard
  # Optional: Can be exposed or accessed via VPN/SSH tunnel
  # ===========================================
  flower:
    image: mher/flower:2.0
    command: >
      celery
      --broker=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/1
      flower
      --port=5555
      --basic-auth=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
      --url_prefix=${FLOWER_URL_PREFIX:-}
    # Bind to localhost only for security - access via SSH tunnel
    # For external access, change to "0.0.0.0" or remove "127.0.0.1:"
    ports:
      - "${FLOWER_BIND:-127.0.0.1}:${FLOWER_PORT:-5555}:5555"
    environment:
      - CELERY_BROKER_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/1
      - CELERY_RESULT_BACKEND=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/2
    depends_on:
      redis:
        condition: service_healthy
      celery-worker:
        condition: service_started
    networks:
      - monitoring-network
    restart: unless-stopped
    profiles:
      - monitoring
    deploy:
      resources:
        limits:
          memory: ${FLOWER_MEMORY_LIMIT:-256M}
          cpus: "${FLOWER_CPU_LIMIT:-0.5}"

  # ===========================================
  # PostgreSQL Database
  # Internal only - NO external port exposed
  # ===========================================
  db:
    image: postgres:${POSTGRES_VERSION:-16}-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-docuscan}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-docuscan}
      - POSTGRES_DB=${POSTGRES_DB:-docuscan}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    # NO ports exposed - only accessible within data-network
    # Uncomment for debugging only (bind to localhost):
    # ports:
    #   - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"
    networks:
      - data-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-docuscan} -d ${POSTGRES_DB:-docuscan}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${POSTGRES_MEMORY_LIMIT:-512M}
          cpus: "${POSTGRES_CPU_LIMIT:-1}"

  # ===========================================
  # Redis - Cache & Message Broker
  # Internal only - NO external port exposed
  # ===========================================
  redis:
    image: redis:${REDIS_VERSION:-7}-alpine
    command: >
      redis-server
      --appendonly yes
      --maxmemory ${REDIS_MAXMEMORY:-256mb}
      --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
      ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    volumes:
      - redis-data:/data
    # NO ports exposed - only accessible within internal networks
    # Uncomment for debugging only (bind to localhost):
    # ports:
    #   - "127.0.0.1:${REDIS_PORT:-6379}:6379"
    networks:
      - data-network
      - monitoring-network
    healthcheck:
      test: ["CMD", "redis-cli", "${REDIS_PASSWORD:+-a ${REDIS_PASSWORD}}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEMORY_LIMIT:-512M}
          cpus: "${REDIS_CPU_LIMIT:-0.5}"

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  upload-data:
    driver: local

# ===========================================
# Network Segmentation for Security
# ===========================================
# 
# Network topology:
#
#   [Internet]
#       |
#       v
#   +-------------------+
#   |     frontend      |  <- Only exposed service (port 80)
#   +-------------------+
#       |
#       | frontend-network (external facing)
#       | backend-network  (internal)
#       v
#   +-------------------+
#   |     backend       |  <- No external port
#   +-------------------+
#       |
#       | data-network (internal only)
#       v
#   +-------+  +-------+
#   |  db   |  | redis |  <- No external ports
#   +-------+  +-------+
#                  |
#                  | monitoring-network (internal only)
#                  v
#              +--------+
#              | flower |  <- localhost only (SSH tunnel)
#              +--------+
#
networks:
  # Public-facing network (frontend only)
  frontend-network:
    driver: bridge
    internal: false
  
  # Frontend <-> Backend communication
  backend-network:
    driver: bridge
    internal: true
  
  # Backend/Celery <-> Database/Redis (fully internal)
  data-network:
    driver: bridge
    internal: true
  
  # Flower <-> Redis monitoring (fully internal)
  monitoring-network:
    driver: bridge
    internal: true
